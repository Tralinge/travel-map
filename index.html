<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Travel Map</title>

<!-- Leaflet CSS -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<!-- MarkerCluster CSS -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
html, body {
  height: 100%;
  margin: 0;
}

/* ===== LAYOUT ===== */
#container {
  display: flex;
  height: 100%;
  width: 100%;
}

#map {
  flex: 2;
}

#sidebar {
  flex: 1;
  max-width: 400px;
  padding: 12px;
  overflow-y: auto;
  border-left: 1px solid #ccc;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background-color: #f9f9f9;
}

#sidebar img {
  width: 100%;
  margin-bottom: 12px;
  border-radius: 6px;
  cursor: pointer;
}

#sidebar-handle {
  width: 40px;
  height: 5px;
  background: #bbb;
  border-radius: 3px;
  margin: 8px auto 6px auto;
}

#sidebar-handle::after {
  content: "—";
  font-size: 24px;
  color: #666;
}

/* ===== CUSTOM YEAR MARKER ===== */
.year-div-icon {
  background: transparent !important;
  border: none !important;
}

.year-marker {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.year-label {
  display: none;
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
  font-size: 11px;
  font-weight: 600;
  background: rgba(255, 255, 255, 0.95);
  padding: 2px 6px;
  border-radius: 8px;
  margin-bottom: 6px;
  box-shadow: 0 0 2px rgba(0,0,0,0.3);
  pointer-events: none;
}

/* Visible only when marker is hovered */
.year-marker.hover .year-label {
  display: block;
}

.pin {
  width: 12px;
  height: 12px;
  flex-shrink: 0;
  border-radius: 50%;
  border: 2px solid white;
  box-shadow: 0 0 3px rgba(0,0,0,0.4);
}

/* ===== LIGHTBOX ===== */
#lightbox {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

#lightbox-close {
  position: absolute;
  top: 10px;
  right: 14px;
  font-size: 36px;
  color: #d4d3cf;
  cursor: pointer;
  background: rgba(0,0,0,0.6);
  border-radius: 20%;
  padding: 6px 8px;
}

.lightbox-inner {
  display: flex;
  align-items: center;
  justify-content: center;
  max-width: 95%;
  max-height: 80%;
}

#lightbox-img {
  max-width: 85vw;
  max-height: 75vh;
  border-radius: 6px;
}

.lightbox-arrow {
  font-size: 48px;
  color: #fff;
  cursor: pointer;
  padding: 12px;
  user-select: none;
}

/* ===== DOTS ===== */
#lightbox-dots {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

#lightbox-dots span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255,255,255,0.4);
  cursor: pointer;
}

#lightbox-dots span.active {
  background: rgba(255,255,255,0.9);
}

/* ===== MOBILE ===== */
@media (max-width: 768px) {
  #container {
    flex-direction: column;
    height: 100dvh;
  }

  #map {
    flex: 1 1 auto;
  }

  #sidebar {
    flex: none;
    height: 50%;
    transition: height 0.25s ease;
  }

  #sidebar.collapsed {
    height: 20%;
  }

  #sidebar.expanded {
    height: 50%;
  }

  #sidebar-handle {
    height: 24px;
    width: 60px;
    margin: 8px auto;
  }

  .lightbox-arrow {
    font-size: 36px;
  }

  #lightbox-dots span {
    width: 10px;
    height: 10px;
  }

  .leaflet-top {
    top: 60px;
  }
}
</style>
</head>

<body>

<div id="container">
  <div id="map"></div>
  <div id="sidebar" class="expanded">
    <div id="sidebar-handle"></div>
    <h2 id="place-title">Travel Map</h2>
    <div id="place-content">
      <p>Click a marker on the map to see photos.</p>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox">
  <span id="lightbox-close">&times;</span>

  <div class="lightbox-inner">
    <span id="lightbox-prev" class="lightbox-arrow">&#10094;</span>
    <img id="lightbox-img" alt="">
    <span id="lightbox-next" class="lightbox-arrow">&#10095;</span>
  </div>

  <div id="lightbox-dots"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/* ===== MAP INIT ===== */
const map = L.map("map", { zoomControl: false }).setView([20, 0], 2);
L.control.zoom({ position: "bottomright" }).addTo(map);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

const markerCluster = L.markerClusterGroup({ maxClusterRadius: 20 });

/* ===== COLOR SCIENCE ===== */
const WL_MIN = 410;
const WL_MAX = 680;

function yearToWavelength(year, minYear, maxYear) {
  if (minYear === maxYear) return (WL_MIN + WL_MAX) / 2;
  return WL_MAX - ((year - minYear) / (maxYear - minYear)) * (WL_MAX - WL_MIN);
}

function wavelengthToRGB(wl) {
  let r=0,g=0,b=0;
  if (wl<440){r=-(wl-440)/30;b=1;}
  else if (wl<490){g=(wl-440)/50;b=1;}
  else if (wl<510){g=1;b=-(wl-510)/20;}
  else if (wl<580){r=(wl-510)/70;g=1;}
  else if (wl<645){r=1;g=-(wl-645)/65;}
  else{r=1;}

  const to255=v=>Math.round(255*Math.pow(Math.max(v,0.35),0.8));
  return `rgb(${to255(r)},${to255(g)},${to255(b)})`;
}

/* ===== STATE ===== */
let currentPhotos = [];
let currentIndex = 0;

/* ===== SIDEBAR ===== */
function updateSidebar(place) {
  document.getElementById("place-title").textContent =
    `${place.year} - ${place.text} - ${place.title}`;

  const content = document.getElementById("place-content");
  content.innerHTML = "";

  currentPhotos = place.photos || [];
  currentPhotos.forEach((src, i) => {
    const img = document.createElement("img");
    img.src = src;
    img.onclick = () => openLightbox(i);
    content.appendChild(img);
  });
}

/* ===== DATA LOAD ===== */
fetch("places.json")
  .then(r => r.json())
  .then(places => {
    const years = places.map(p => p.year);
    const minYear = Math.min(...years);
    const maxYear = Math.max(...years);
    const bounds = L.latLngBounds();

    places.forEach(place => {
      const color = wavelengthToRGB(
        yearToWavelength(place.year, minYear, maxYear)
      );

      const icon = L.divIcon({
        className: "year-div-icon",
        html: `
          <div class="year-marker">
            <div class="year-label"></div>
            <div class="pin" style="background:${color}"></div>
          </div>
        `,
        iconAnchor: [6, 6]   // center of the 12×12 pin
      });

      const marker = L.marker([place.lat, place.lng], { icon });

      /* CLICK */
      marker.on("click", () => {
        map.setView([place.lat, place.lng], 6);
        updateSidebar(place);
        if (window.innerWidth <= 768) {
          document.getElementById("sidebar")
            .scrollIntoView({ behavior: "smooth" });
        }
      });

      /* HOVER */
      marker.on("mouseover", e => {
        const el = e.target.getElement();
        if (!el) return;

        const markerDiv = el.querySelector(".year-marker");
        const label = el.querySelector(".year-label");

        if (markerDiv && label) {
          label.textContent = `${place.year} – ${place.text} in ${place.title}`;
          markerDiv.classList.add("hover");
        }
      });

      marker.on("mouseout", e => {
        const el = e.target.getElement();
        if (!el) return;

        const markerDiv = el.querySelector(".year-marker");
        if (markerDiv) {
          markerDiv.classList.remove("hover");
        }
      });

      markerCluster.addLayer(marker);
      bounds.extend([place.lat, place.lng]);
    });

    map.addLayer(markerCluster);
    map.fitBounds(bounds, { padding: [50,50] });
  });

/* ===== LIGHTBOX ===== */
function renderDots() {
  const dots = document.getElementById("lightbox-dots");
  dots.innerHTML = "";
  if (currentPhotos.length <= 1) return;

  currentPhotos.forEach((_, i) => {
    const d = document.createElement("span");
    if (i === currentIndex) d.classList.add("active");
    d.onclick = () => showIndex(i);
    dots.appendChild(d);
  });
}

function showIndex(i) {
  currentIndex = i;
  document.getElementById("lightbox-img").src = currentPhotos[currentIndex];
  renderDots();
}

function openLightbox(i) {
  document.getElementById("lightbox").style.display = "flex";
  showIndex(i);
}

function closeLightbox() {
  document.getElementById("lightbox").style.display = "none";
}

function showNext() {
  showIndex((currentIndex + 1) % currentPhotos.length);
}

function showPrev() {
  showIndex((currentIndex - 1 + currentPhotos.length) % currentPhotos.length);
}

document.getElementById("lightbox-close").onclick = closeLightbox;
document.getElementById("lightbox-next").onclick = showNext;
document.getElementById("lightbox-prev").onclick = showPrev;

document.addEventListener("keydown", e => {
  if (e.key === "Escape") closeLightbox();
  if (e.key === "ArrowRight") showNext();
  if (e.key === "ArrowLeft") showPrev();
});

let startX = null;
document.getElementById("lightbox").addEventListener("touchstart", e => {
  startX = e.touches[0].clientX;
});
document.getElementById("lightbox").addEventListener("touchend", e => {
  if (!startX) return;
  const diff = e.changedTouches[0].clientX - startX;
  if (diff > 50) showPrev();
  if (diff < -50) showNext();
  startX = null;
});

/* ==== Sidebar collapse ==== */
const sidebar = document.getElementById("sidebar");
const handle = document.getElementById("sidebar-handle");

/* Collapse when map is tapped (mobile only) */
map.on("click", () => {
  if (window.innerWidth <= 768) {
    sidebar.classList.add("collapsed");
    sidebar.classList.remove("expanded");
  }
});

/* Toggle when handle is tapped */
if (handle && sidebar) {
  handle.addEventListener("click", () => {
    sidebar.classList.toggle("collapsed");
    sidebar.classList.toggle("expanded");
  });
}
</script>

</body>
</html>
